<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Response verification :: Smart-ID documentation</title>
    <link rel="canonical" href="https://sk-eid.github.io/smart-id-documentation/rp-api/response_verification.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../_/css/site.css">

<link rel="icon" href="../_/img/favicon.svg" type="image/x-icon">
  </head>
  <body class="article -toc">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://sk-eid.github.io/smart-id-documentation">
        <img src="../_/img/sk-id-solutions.svg" class="logo" />
      </a>
      <span class="separator"></span>
      <span class="title">Smart-ID documentation</span>
    </div>

    <div class="navbar-right">
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="nav-toggle"></button>    </div>

  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rp-api" data-version="3.1.6">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="introduction.html">Relying Party API</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Smart-ID Documentation</span>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Getting started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../demo.html">Try out</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../implementation.html">Smart-ID integration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../environments.html">Environments</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../device_link.html">Device link fallback page</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../https_pinning.html">HTTPS pinning</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../client_libraries.html">Client libraries</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../suggestions.html">Suggestions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../logos.html">Logos</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../contact.html">Contact</a>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Automated testing</span>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="mock_service.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="device_link_test_endpoint.html">Device link test endpoint</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../test_accounts.html">Test accounts</a>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Relying Party API</span>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="introduction.html">Introduction</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="changes.html">Changes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="glossary.html">Glossary</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="overview_of_api_endpoints.html">Overview of API endpoints</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="api_specification.html">OpenAPI specification</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="device_link_flows.html">Device link flows</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="authcode.html"><code>authCode</code> calculation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="notification_based_flows.html">Notification based flows</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="api_details.html">API technical description</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="interactions.html">Interactions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="signature_protocols.html">Signature protocols</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="callback_urls.html">Callback URLs</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="response_verification.html">Response verification</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="additional_security_measures.html">Additional security measures</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Relying Party API</span>
    <span class="version">3.1.6</span>
  </div>
  <ul class="components">
    <li class="component">
      <div class="title"><a href="../index.html">Documentation</a></div>
    </li>
    <li class="component is-current">
      <div class="title"><a href="introduction.html">Relying Party API</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="introduction.html">3.1.6</a>
        </li>
        <li class="version">
          <a href="3.1.5/introduction.html">3.1.5</a>
        </li>
        <li class="version">
          <a href="3.1.4/introduction.html">3.1.4</a>
        </li>
        <li class="version">
          <a href="3.1.3/introduction.html">3.1.3</a>
        </li>
        <li class="version">
          <a href="3.0.3/introduction.html">3.0.3</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
  <div class="content">
<aside class="toc sidebar" data-title="On this page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Response verification</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>After receiving the transaction response from the session status API call the following algorithm must be used to decide</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if the authentication result is trustworthy and what the identity of the authenticating end user is,</p>
</li>
<li>
<p>if the signature result is valid.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In App2App and Web2App flows, the response verification step must be performed after the user has returned via the callback URL, as described in <a href="callback_urls.html" class="xref page">Callback URLs</a> page.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_response_verification_steps"><a class="anchor" href="#_response_verification_steps"></a>Response verification steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following steps perform the response verification algorithm. Note that the algorithm is applicable to both authentication and signature session flows. Specific differences, such as the conditional execution of Steps 1 and 3, are noted within the steps.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Session secret verification (applicable only for sessions with flow type <code>Web2App</code> or <code>App2App</code>):</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Base64 decode the <code>sessionSecret</code> string received in the initial request.</p>
</li>
<li>
<p>Calculate the SHA-256 digest of the Base64 decoded <code>sessionSecret</code> value.</p>
</li>
<li>
<p>Encode the raw bytes of the calculated hash using Base64URL.</p>
</li>
<li>
<p>Obtain the <code>sessionSecretDigest</code> value from the callback URL parameter visited by the user upon returning to the RP website or application.</p>
</li>
<li>
<p>Verify that this Base64URL encoded hash result exactly matches the <code>sessionSecretDigest</code> obtained from the callback URL.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Initial session response check:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Verify the <code>state</code> field in the JSON response is exactly <code>COMPLETE</code>.</p>
</li>
<li>
<p>Verify the <code>result.endResult</code> field is exactly <code>OK</code>.</p>
</li>
<li>
<p>Verify the <code>signatureProtocol</code> field is exactly <code>ACSP_V2</code> in case of authentication or <code>RAW_DIGEST_SIGNATURE</code> in case of signature.</p>
</li>
<li>
<p>Ensure the <code>cert</code>, <code>signature</code>, and <code>result</code> objects are present and not null.</p>
</li>
</ol>
</div>
</li>
<li>
<p>User challenge verification (applicable only for authentication sessions with flow type <code>Web2App</code> or <code>App2App</code>):</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Obtain the <code>userChallengeVerifier</code> value from the callback URL parameter visited by the user upon returning to the RP website or application.</p>
</li>
<li>
<p>Calculate the SHA-256 digest of the received <code>userChallengeVerifier</code> string.</p>
</li>
<li>
<p>Encode the raw bytes of the calculated hash using Base64URL.</p>
</li>
<li>
<p>Verify that this Base64URL encoded hash result exactly matches the <code>signature.userChallenge</code> string provided in the JSON response&#8217;s signature object.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Certificate Chain Validation and Trust:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Decode the Base64 encoded end-entity certificate string from <code>cert.value</code> and parse it into a standard X.509 certificate representation. The RP API provides only the end-entity certificate, the Relying Party must have the necessary root and intermediate CA certificates configured locally to allow the library to build the full certificate chain.
For these certificates, see <a href="https://www.skidsolutions.eu/resources/certificates/">Certificates</a> page.</p>
</li>
<li>
<p>Using a standard cryptographic library, initiate the validation of the certificate chain starting from the end-entity certificate. Provide the end-entity certificate to the library, along with configuring it with the set of trusted CA certificates (trust anchors).</p>
<div class="ulist">
<ul>
<li>
<p>It&#8217;s important to note that some libraries use the system certificate store in addition to the provided CA certificates, this should be disabled and only the explicitly configured CA certificates should be used.</p>
</li>
</ul>
</div>
</li>
<li>
<p>For each certificate in the constructed chain (end-entity certificate and all intermediate CA certificates), perform the following checks. A standard cryptographic library will typically perform the following checks as part of its overall chain validation routine and report the result as a success or failure.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Verify the certificate&#8217;s digital signature using the public key of its issuer certificate.</p>
</li>
<li>
<p>Verify the certificate&#8217;s validity period against the current time, i.e., not before the <code>notBefore</code> date and not after the <code>notAfter</code> date.</p>
</li>
<li>
<p>Verify that the certificate has not been revoked. This check should be performed using the Online Certificate Status Protocol (OCSP), utilizing the Authority Information Access (AIA) extension within the certificate to locate the OCSP responder URL. If OCSP fails or is unavailable, Certificate Revocation List (CRL) checking should be used as fallback.</p>
<div class="olist upperalpha">
<ol class="upperalpha" type="A">
<li>
<p>Note: Revocation checks (OCSP/CRL) are not performed on self-signed root CA certificates configured as trust anchors. Intermediate CA certificates can be revoked and must be checked.</p>
</li>
<li>
<p>Note: OCSP responses are digitally signed. The certificate chain of the OCSP responder itself should also be verified, ensuring it is trusted and authorized to provide status for the certificate being checked.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Verify basic constraints are appropriate: Intermediate CA certificates must have the Basic Constraints extension present with the <code>cA</code> boolean set to <code>TRUE</code>. For end-entity certificates, the Basic Constraints extension should either absent, or if present, its <code>cA</code> boolean should be set to <code>FALSE</code>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Smart-ID Scheme Identification (End-Entity Certificate):</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Before checking specific purposes, verify that the end-entity certificate belongs to the Smart-ID scheme.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Examine the Certificate Policies extension of the end-entity certificate.
The certificate must contain <strong>all the</strong> specific policy OIDs designated by SK ID Solutions for the Smart-ID scheme (as defined in Chapter 2.2.3 of the "Certificate and OCSP Profile for Smart-ID" in <a href="https://www.skidsolutions.eu/resources/profiles/">Certificate Profiles</a> page). These OIDs differentiate Smart-ID certificates from other types of certificates (e.g., Mobile-ID, Estonian ID-card). The Relying Party must consult the current official SK ID Solutions Certificate Policies for the definitive list of Smart-ID scheme policy OIDs. For these certificate policies, see <a href="https://www.skidsolutions.eu/resources/certificate-policies/">Certificate Policies</a> page.</p>
</li>
<li>
<p>If not all the recognized Smart-ID scheme policy OIDs are present, the certificate should not be processed as a Smart-ID certificate, and the verification should fail for this context.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>End-Entity Certificate Purpose Validation (Smart-ID Context):</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Examine the end-entity certificate for extensions and attributes required by the certificate profile.
For these certificate profiles, see <a href="https://www.skidsolutions.eu/resources/profiles/">Certificate Profiles</a> page.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>For Smart-ID authentication: To confirm the certificate is suitable for authentication, it <strong>must</strong> contain one of the following:</p>
<div class="ulist">
<ul>
<li>
<p>The <code>digitalSignature</code> key usage <strong>and</strong> the <code>Smart-ID authentication</code> (<code>1.3.6.1.4.1.62306.5.7.0</code>) Extended Key Usage which is present in certificates issued April 2025 onwards.</p>
</li>
<li>
<p>The <code>digitalSignature</code>, <code>keyEncipherment</code>, <code>dataEncipherment</code> key usages <strong>and</strong> the <code>id-kp-clientAuth</code> (<code>1.3.6.1.5.5.7.3.2</code>) Extended Key Usage which is found in older, still valid certificates issued before April 2025.</p>
</li>
</ul>
</div>
</li>
<li>
<p>For digital signing: Check for appropriate key usage <code>nonRepudiation</code>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Assurance Level Check:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Extract the assurance level string from <code>cert.certificateLevel</code> (e.g., <code>ADVANCED</code>, <code>QUALIFIED</code>).</p>
</li>
<li>
<p>For qualified certificates, check that the extension values as defined by the certificate profile exist within the certificate from <code>cert.value</code>.</p>
</li>
<li>
<p>Compare this level against the minimum assurance level required by the RP for the specific context or transaction. Ensure the certificate&#8217;s level meets or exceeds the required level (note that <code>ADVANCED &lt; QUALIFIED</code>).</p>
</li>
</ol>
</div>
</li>
<li>
<p>Identity Match Check:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Extract the authenticated user&#8217;s identifier from the end-entity certificate. For Smart-ID certificates <code>serialNumber</code> (OID <code>2.5.4.5</code>) under <code>Subject DN</code> contain the national identity code, for example <code>PNOEE-30001010004</code>.</p>
</li>
<li>
<p>If the RP initiated the authentication or signing for a specific known user, verify that the extracted identifier matches the expected identity for that session.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Verification of <code>signature</code> Object (authentication/signature session):</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Only for authentication session: Reconstruct the exact <code>ACSP_V2_payload</code> string that was signed, as described under <a href="signature_protocols.html#acsp_v2_digest_calculation" class="xref page"><code>ACSP_V2</code> digest calculation</a>. This is done by concatenating the fields in order, separated by the vertical bar character <code>|</code> (U+007C):</p>
<div class="listingblock wrap">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">'smart-id'|'ACSP_V2'|serverRandom|rpChallenge|userChallenge|BASE64(relyingPartyName)|BASE64(brokeredRpName)|BASE64(SHA-256(interactions))|interactionTypeUsed|initialCallbackUrl|flowType</code></pre>
</div>
</div>
</li>
<li>
<p>Only for signature session: Use the data-to-be-signed, a digest of which was initially sent when initiating the signature session (as described in <a href="signature_protocols.html#raw_digest_signature_protocol" class="xref page"><code>RAW_DIGEST_SIGNATURE</code> signature protocol</a>).</p>
</li>
<li>
<p>Decode the signature value from <code>signature.value</code> using Base64 decoding.</p>
</li>
<li>
<p>Obtain the public key from the parsed end-entity user certificate (from Step 4).</p>
</li>
<li>
<p>Only for authentication session: Using a cryptographic library, verify the decoded signature against the UTF-8 bytes of the reconstructed <code>ACSP_V2_payload</code> string.</p>
</li>
<li>
<p>Only for signature session: Using a cryptographic library, verify the decoded signature against either the data-to-be-signed or the hash of the data-to-be-signed (there are libraries that provide options for either).</p>
</li>
<li>
<p>Ensure the verification uses the algorithm specified in <code>signature.signatureAlgorithm</code> (e.g., rsassa-pss) and correctly applies the parameters from <code>signature.signatureAlgorithmParameters</code> (e.g., hash algorithm like <code>SHA-512</code>, MGF1 hash like <code>SHA-512</code>, salt length like <code>64</code>, and the trailer field <code>0xbc</code>).</p>
</li>
</ol>
</div>
</li>
<li>
<p>Session Management (Only for authentication sessions. <strong>Important:</strong> only perform if all the preceding steps (1-9) were successful):</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Invalidate any previous, unauthenticated session identifier associated with the user&#8217;s interaction (e.g., browser cookie or API token used before successful authentication).</p>
</li>
<li>
<p>Generate a new, secure, and unique session identifier representing the now authenticated state.</p>
</li>
<li>
<p>Associate the authenticated user&#8217;s identity (from Step 8) and potentially the assurance level (from Step 7) with this new session identifier in your server-side session store.</p>
</li>
</ol>
</div>
</li>
<li>
<p>After a successful action, the users should be able to view their actions or download the signed document. For more information, see <a href="additional_security_measures.html#allowing-users-to-verify-operations" class="xref page">Allowing users to verify operations</a> section.</p>
</li>
</ol>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>© 2024 SK ID Solutions AS</p>
</footer>
<script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async src="../_/js/vendor/highlight.js"></script>
<script async src="../_/js/vendor/tabs.js" data-sync-storage-key="language"></script>
<script src="../_/js/vendor/lunr.js"></script>
<script src="../_/js/search-ui.js" id="search-ui-script" data-site-root-path=".." data-snippet-length="100" data-stylesheet="../_/css/search.css"></script>
<script async src="../search-index.js"></script>
  </body>
</html>
